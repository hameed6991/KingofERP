@page "/company-update"

@using System
@using System.IO
@using System.Linq
@using System.Collections.Generic
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using UaeEInvoice.Data
@using UaeEInvoice.Services
@using UaeEInvoice.Services.Auth

@attribute [Authorize]

@inject AppDbContext Db
@inject ICurrentCompany CurrentCompany
@inject NavigationManager Nav
@inject LedgerService Ledger
@inject AccountRoleService Roles
@inject IWebHostEnvironment Env

<style>
    .soft-card {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 22px;
    }

    .soft-shadow {
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    .hero {
        border-radius: 22px;
        border: 1px solid rgba(0,0,0,.06);
        background: linear-gradient(135deg, rgba(13,110,253,.12), rgba(255,255,255,0));
        padding: 18px;
    }

    .title {
        font-weight: 900;
        letter-spacing: .2px;
        margin: 0;
    }

    .muted {
        color: rgba(0,0,0,.55);
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        padding: .30rem .75rem;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,.08);
        background: #fff;
        font-size: .85rem;
        white-space: nowrap;
    }

    .section-title {
        font-weight: 900;
        letter-spacing: .2px;
    }

    .preview-card {
        border-radius: 18px;
        border: 1px solid rgba(0,0,0,.06);
        background: linear-gradient(180deg, rgba(13,110,253,.06), rgba(0,0,0,0));
    }

    .logo-box {
        width: 84px;
        height: 84px;
        border-radius: 16px;
        border: 1px dashed rgba(0,0,0,.18);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: #fafafa;
    }

        .logo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .step-pill {
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 999px;
        padding: .45rem .85rem;
        background: #fff;
        cursor: pointer;
        user-select: none;
    }

        .step-pill.active {
            background: rgba(13,110,253,.10);
            border-color: rgba(13,110,253,.35);
            font-weight: 800;
        }

        .step-pill.done {
            background: rgba(25,135,84,.10);
            border-color: rgba(25,135,84,.35);
        }

    .field-hint {
        font-size: .82rem;
        color: rgba(0,0,0,.55);
    }
</style>

<div class="container-xxl py-4">

    <div class="hero mb-3">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h2 class="title">Company Update</h2>
                    <span class="chip">🏢 Settings</span>
                </div>
                <div class="muted">Update company profile, TRN and invoice settings.</div>

                <div class="d-flex flex-wrap gap-2 mt-2">
                    <span class="chip">🏢 CompanyId: @_companyId</span>
                    <span class="chip">🧾 Preview: @PreviewInvoiceNumber()</span>
                    <span class="chip">💱 Currency: @_model.CurrencyCode</span>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" type="button" @onclick="Reload" disabled="@(_saving || _loading)">
                    Reload
                </button>

                <button class="btn btn-primary" type="button" @onclick="Save" disabled="@(_saving || _loading)">
                    @(_saving ? "Saving..." : "Save Changes")
                </button>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger soft-card soft-shadow p-3">
            <strong>Error:</strong> @_error
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <div class="alert alert-success soft-card soft-shadow p-3">
            <strong>Saved!</strong> @_message
        </div>
    }

    @if (_loading)
    {
        <div class="soft-card soft-shadow p-3">
            <div class="text-muted">Loading company settings...</div>
        </div>
    }
    else
    {
        <div class="d-flex flex-wrap gap-2 mb-3">
            <div class="step-pill @(IsActive(1) ? "active" : (IsDone(1) ? "done" : ""))" @onclick="@(() => GoStep(1))">1) Business</div>
            <div class="step-pill @(IsActive(2) ? "active" : (IsDone(2) ? "done" : ""))" @onclick="@(() => GoStep(2))">2) Address & Tax</div>
            <div class="step-pill @(IsActive(3) ? "active" : (IsDone(3) ? "done" : ""))" @onclick="@(() => GoStep(3))">3) Invoice</div>
        </div>

        <div class="row g-3">
            <div class="col-12 col-lg-8">
                <div class="soft-card soft-shadow p-3 p-md-4">

                    @if (_step == 1)
                    {
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                            <div>
                                <div class="section-title">1) Business Profile</div>
                                <div class="muted small">Used across invoices and reports.</div>
                            </div>

                            <div class="d-flex align-items-center gap-3">
                                <div class="logo-box">
                                    @if (!string.IsNullOrWhiteSpace(_logoPreviewUrl))
                                    {
                                        <img src="@_logoPreviewUrl" alt="Logo" />
                                    }
                                    else if (!string.IsNullOrWhiteSpace(_model.LogoPath))
                                    {
                                        <img src="@($"{_model.LogoPath}?v={DateTime.UtcNow.Ticks}")" alt="Logo" />
                                    }
                                    else
                                    {
                                        <span class="text-muted small">LOGO</span>
                                    }
                                </div>

                                <div>
                                    <label class="form-label mb-1">Company Logo (optional)</label>
                                    <InputFile OnChange="OnLogoSelected" accept="image/*" />
                                    <div class="field-hint">Recommended: square PNG/JPG (≤2MB).</div>
                                </div>
                            </div>
                        </div>

                        <hr />

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Legal Company Name <span class="text-danger">*</span></label>
                                <input class="form-control" value="@(_model.LegalName ?? "")" @oninput="OnLegalNameInput" />
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Short Name <span class="text-danger">*</span></label>
                                <input class="form-control" value="@(_model.ShortName ?? "")" @oninput="OnShortNameInput" />
                                <div class="field-hint">Required (DB column NOT NULL).</div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Industry</label>
                                <select class="form-select" @onchange="OnIndustryChanged">
                                    <option value="" selected="@string.IsNullOrWhiteSpace(_model.Industry)">-- Select Industry --</option>
                                    @foreach (var i in _industries)
                                    {
                                        <option value="@i" selected="@(_model.Industry == i)">@i</option>
                                    }
                                </select>
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Business Type</label>
                                <input class="form-control" value="@(_model.BusinessType ?? "")" @oninput="OnBusinessTypeInput" />
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Currency</label>
                                <select class="form-select" @onchange="OnCurrencyChanged">
                                    @foreach (var c in _currencies)
                                    {
                                        <option value="@c" selected="@(_model.CurrencyCode == c)">@c</option>
                                    }
                                </select>
                            </div>
                        </div>
                    }

                    @if (_step == 2)
                    {
                        <div class="section-title">2) Address & Tax</div>
                        <div class="muted small">Printed on invoice header.</div>

                        <hr />

                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label">TRN <span class="text-danger">*</span></label>
                                <input class="form-control" value="@(_model.TRN ?? "")" @oninput="OnTrnInput" maxlength="15" />
                                <div class="field-hint">TRN must be exactly 15 digits.</div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Country</label>
                                <input class="form-control" value="@(_model.Country ?? "")" @oninput="OnCountryInput" />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Address Line 1</label>
                                <input class="form-control" value="@(_model.AddressLine1 ?? "")" @oninput="OnAddr1Input" />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Address Line 2</label>
                                <input class="form-control" value="@(_model.AddressLine2 ?? "")" @oninput="OnAddr2Input" />
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Emirate</label>
                                <input class="form-control" value="@(_model.Emirate ?? "")" @oninput="OnEmirateInput" />
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">City</label>
                                <input class="form-control" value="@(_model.City ?? "")" @oninput="OnCityInput" />
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">PO Box</label>
                                <input class="form-control" value="@(_model.POBox ?? "")" @oninput="OnPoBoxInput" />
                            </div>
                        </div>
                    }

                    @if (_step == 3)
                    {
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                            <div>
                                <div class="section-title">3) Invoice Settings</div>
                                <div class="muted small">Prefix & numbering.</div>
                            </div>

                            <div class="preview-card p-3">
                                <div class="small muted">Invoice No Preview</div>
                                <div class="fw-bold fs-5">@PreviewInvoiceNumber()</div>
                            </div>
                        </div>

                        <hr />

                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <label class="form-label">Invoice Prefix <span class="text-danger">*</span></label>
                                <input class="form-control" value="@(_model.InvoicePrefix ?? "")" @oninput="OnInvoicePrefixInput" />
                            </div>

                            <div class="col-12 col-md-6">
                                <label class="form-label">Next Invoice Number</label>
                                <input class="form-control" value="@_model.NextInvoiceNumber" @oninput="OnNextInvoiceNumberInput" />
                            </div>
                        </div>
                    }

                    <hr />

                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-secondary" @onclick="PrevStep" disabled="@(_step == 1)">⬅ Back</button>
                        <div class="muted small">Step @_step / 3</div>
                        <button type="button" class="btn btn-primary" @onclick="NextStep" disabled="@(_step == 3)">Next ➜</button>
                    </div>

                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="soft-card soft-shadow p-3">
                    <div class="section-title">Quick Actions</div>
                    <div class="muted small">Navigate safely without quote issues.</div>

                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-outline-secondary" type="button" @onclick="GoSetupPage">
                            Go Company Setup
                        </button>

                        <button class="btn btn-outline-primary" type="button" @onclick="GoCustomers">
                            Go Customers
                        </button>
                    </div>

                    <div class="mt-3 p-3 preview-card">
                        <div class="small muted">Current Preview</div>
                        <div class="fw-bold">@PreviewInvoiceNumber()</div>
                        <div class="small muted mt-2">TRN: <span class="fw-semibold">@_model.TRN</span></div>
                    </div>
                </div>
            </div>

        </div>
    }
</div>

@code {
    private Company _model = new();
    private bool _loading = true;
    private bool _saving = false;
    private string? _message;
    private string? _error;
    private int _companyId;

    private int _step = 1;

    private IBrowserFile? _logoFile;
    private string? _logoPreviewUrl;

    private readonly List<string> _industries = new()
    {
        "Accounting & Auditing","Advertising / Marketing","Automotive","Construction",
        "E-Commerce","Education / Training","Electronics","Food & Beverage","Healthcare / Clinic",
        "Hospitality / Hotel","IT Services / Software","Logistics / Transport","Manufacturing",
        "Real Estate","Retail / Trading","Salon / Spa","Travel & Tourism","Other"
    };

    private readonly List<string> _currencies = new() { "AED", "USD", "EUR", "INR", "SAR", "QAR" };

    private bool IsActive(int s) => _step == s;
    private bool IsDone(int s) => _step > s;

    private void GoStep(int s)
    {
        if (s < 1) s = 1;
        if (s > 3) s = 3;
        _step = s;
    }
    private void NextStep() { if (_step < 3) _step++; }
    private void PrevStep() { if (_step > 1) _step--; }

    protected override async Task OnInitializedAsync()
    {
        await CurrentCompany.RefreshAsync();
        await Load();
    }

    private async Task Load()
    {
        _loading = true;
        _message = null;
        _error = null;
        _logoFile = null;
        _logoPreviewUrl = null;

        try
        {
            await CurrentCompany.RefreshAsync();
            _companyId = CurrentCompany.CompanyId;

            if (_companyId <= 0)
            {
                _error = "CompanyId claim not found. Logout & login again.";
                return;
            }

            var existing = await Db.Companies
                .AsNoTracking()
                .FirstOrDefaultAsync(x => x.CompanyId == _companyId);

            _model = existing ?? new Company
                {
                    CompanyId = _companyId,
                    Emirate = "Dubai",
                    City = "Dubai",
                    Country = "United Arab Emirates",
                    CurrencyCode = "AED",
                    InvoicePrefix = "INV",
                    NextInvoiceNumber = 1,
                    DefaultVatRate = 0.05m,
                    ShortName = ""
                };
        }
        catch (Exception ex)
        {
            _error = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Reload()
    {
        await Load();
        StateHasChanged();
    }

    private void OnLegalNameInput(ChangeEventArgs e) => _model.LegalName = e.Value?.ToString() ?? "";
    private void OnShortNameInput(ChangeEventArgs e) => _model.ShortName = e.Value?.ToString() ?? "";
    private void OnIndustryChanged(ChangeEventArgs e) => _model.Industry = e.Value?.ToString() ?? "";
    private void OnBusinessTypeInput(ChangeEventArgs e) => _model.BusinessType = e.Value?.ToString() ?? "";
    private void OnCurrencyChanged(ChangeEventArgs e) => _model.CurrencyCode = e.Value?.ToString() ?? "AED";

    private void OnTrnInput(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString() ?? "";
        var digits = new string(raw.Where(char.IsDigit).ToArray());
        if (digits.Length > 15) digits = digits[..15];
        _model.TRN = digits;
    }

    private void OnCountryInput(ChangeEventArgs e) => _model.Country = e.Value?.ToString() ?? "";
    private void OnAddr1Input(ChangeEventArgs e) => _model.AddressLine1 = e.Value?.ToString() ?? "";
    private void OnAddr2Input(ChangeEventArgs e) => _model.AddressLine2 = e.Value?.ToString() ?? "";
    private void OnPoBoxInput(ChangeEventArgs e) => _model.POBox = e.Value?.ToString() ?? "";
    private void OnEmirateInput(ChangeEventArgs e) => _model.Emirate = e.Value?.ToString() ?? "";
    private void OnCityInput(ChangeEventArgs e) => _model.City = e.Value?.ToString() ?? "";

    private void OnInvoicePrefixInput(ChangeEventArgs e) => _model.InvoicePrefix = e.Value?.ToString() ?? "";

    private void OnNextInvoiceNumberInput(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var n)) _model.NextInvoiceNumber = n;
    }

    private async Task OnLogoSelected(InputFileChangeEventArgs e)
    {
        _error = null;

        try
        {
            _logoFile = e.File;
            if (_logoFile == null) return;

            if (_logoFile.Size > 2 * 1024 * 1024)
            {
                _error = "Logo file too large. Please upload under 2MB.";
                _logoFile = null;
                _logoPreviewUrl = null;
                return;
            }

            using var ms = new MemoryStream();
            await _logoFile.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            _logoPreviewUrl = $"data:{_logoFile.ContentType};base64,{base64}";
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _error = ex.InnerException?.Message ?? ex.Message;
            _logoFile = null;
            _logoPreviewUrl = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    private string PreviewInvoiceNumber()
    {
        var num = _model.NextInvoiceNumber <= 0 ? 1 : _model.NextInvoiceNumber;
        var prefix = string.IsNullOrWhiteSpace(_model.InvoicePrefix) ? "INV" : _model.InvoicePrefix;
        return $"{prefix}-{num:000000}";
    }

    private void GoSetupPage() => Nav.NavigateTo("/company-setup");
    private void GoCustomers() => Nav.NavigateTo("/customers");

    private async Task Save()
    {
        _saving = true;
        _message = null;
        _error = null;

        try
        {
            await CurrentCompany.RefreshAsync();
            _companyId = CurrentCompany.CompanyId;

            if (_companyId <= 0)
                throw new Exception("CompanyId claim not found. Logout & login again.");

            _model.CompanyId = _companyId;

            _model.LegalName = (_model.LegalName ?? "").Trim();
            _model.ShortName = (_model.ShortName ?? "").Trim();
            _model.InvoicePrefix = (_model.InvoicePrefix ?? "").Trim();
            _model.Country = (_model.Country ?? "").Trim();
            _model.Emirate = (_model.Emirate ?? "").Trim();
            _model.City = (_model.City ?? "").Trim();

            if (string.IsNullOrWhiteSpace(_model.LegalName)) { _error = "Legal Company Name is required."; _step = 1; return; }
            if (string.IsNullOrWhiteSpace(_model.ShortName)) { _error = "Short Name is required."; _step = 1; return; }
            if ((_model.TRN ?? "").Length != 15 || !(_model.TRN ?? "").All(char.IsDigit)) { _error = "TRN must be exactly 15 digits."; _step = 2; return; }
            if (string.IsNullOrWhiteSpace(_model.InvoicePrefix)) { _error = "Invoice Prefix is required."; _step = 3; return; }

            if (string.IsNullOrWhiteSpace(_model.CurrencyCode)) _model.CurrencyCode = "AED";
            if (_model.NextInvoiceNumber <= 0) _model.NextInvoiceNumber = 1;

            if (_logoFile != null)
            {
                var uploadsRoot = Path.Combine(Env.WebRootPath, "uploads", "company", _companyId.ToString());
                Directory.CreateDirectory(uploadsRoot);

                var ext = Path.GetExtension(_logoFile.Name)?.ToLowerInvariant();
                if (ext != ".png" && ext != ".jpg" && ext != ".jpeg" && ext != ".webp") ext = ".png";

                var fileName = "logo" + ext;
                var savePath = Path.Combine(uploadsRoot, fileName);

                using var fs = new FileStream(savePath, FileMode.Create);
                await _logoFile.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(fs);

                _model.LogoPath = $"/uploads/company/{_companyId}/{fileName}";
            }

            var exists = await Db.Companies.AnyAsync(x => x.CompanyId == _companyId);
            if (!exists) Db.Companies.Add(_model);
            else Db.Companies.Update(_model);

            await Db.SaveChangesAsync();

            await Ledger.EnsureDefaultAccountsAsync(_companyId);

            await AutoMapBaseRolesIfMissing(_companyId);

            _message = "Company updated successfully.";
        }
        catch (Exception ex)
        {
            _error = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    // ✅ Base roles map + always tries PDC roles (upgrade safe)
    private async Task AutoMapBaseRolesIfMissing(int companyId)
    {
        var any = await Db.Set<AccountRoleMap>()
            .AsNoTracking()
            .AnyAsync(x => x.CompanyId == companyId && x.IsActive);

        if (!any)
        {
            var coa = await Db.Set<ChartOfAccount>()
                .AsNoTracking()
                .Where(x => x.CompanyId == companyId)
                .ToListAsync();

            int? FindByName(params string[] keys)
            {
                foreach (var k in keys)
                {
                    var hit = coa.FirstOrDefault(x =>
                        (x.AccountName ?? "").Contains(k, StringComparison.OrdinalIgnoreCase));
                    if (hit != null) return hit.AccountNo;
                }
                return null;
            }

            var cash = FindByName("Cash in hand", "Cash");
            var bank = FindByName("Bank");
            var ar = FindByName("Accounts Receivable", "Receivable");
            var ap = FindByName("Accounts Payable", "Payable");
            var inv = FindByName("Inventory");
            var sales = FindByName("Sales");
            var vatOut = FindByName("VAT Output", "VAT Payable");
            var vatIn = FindByName("VAT Input", "VAT Receivable");
            var cogs = FindByName("Cost of Goods Sold", "COGS");

            cash ??= coa.Any(x => x.AccountNo == 1000) ? 1000 : null;
            bank ??= coa.Any(x => x.AccountNo == 1010) ? 1010 : null;
            ar ??= coa.Any(x => x.AccountNo == 1100) ? 1100 : null;
            inv ??= coa.Any(x => x.AccountNo == 1200) ? 1200 : null;

            ap ??= coa.Any(x => x.AccountNo == 2000) ? 2000 : null;
            vatOut ??= coa.Any(x => x.AccountNo == 2100) ? 2100 : null;
            vatIn ??= coa.Any(x => x.AccountNo == 1500) ? 1500 : null;

            sales ??= coa.Any(x => x.AccountNo == 4000) ? 4000 : null;
            cogs ??= coa.Any(x => x.AccountNo == 5000) ? 5000 : null;

            if (cash.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.CASH, cash.Value);
            if (bank.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.BANK, bank.Value);
            if (ar.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.AR, ar.Value);
            if (ap.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.AP, ap.Value);

            if (inv.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.INVENTORY, inv.Value);
            if (sales.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.SALES, sales.Value);

            if (vatOut.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.VAT_OUTPUT, vatOut.Value);
            if (vatIn.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.VAT_INPUT, vatIn.Value);

            if (cogs.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.COGS, cogs.Value);
        }

        // ✅ Always try PDC roles
        var coa2 = await Db.Set<ChartOfAccount>()
            .AsNoTracking()
            .Where(x => x.CompanyId == companyId)
            .ToListAsync();

        int? FindPdc(params string[] keys)
        {
            foreach (var k in keys)
            {
                var hit = coa2.FirstOrDefault(x =>
                    (x.AccountName ?? "").Contains(k, StringComparison.OrdinalIgnoreCase));
                if (hit != null) return hit.AccountNo;
            }
            return null;
        }

        var pdcRecv = FindPdc("PDC Receivable", "Cheques-in-hand", "Cheque in hand") ?? (coa2.Any(x => x.AccountNo == 1300) ? 1300 : null);
        var pdcPayClr = FindPdc("PDC Payable Clearing", "PDC Payable", "Cheque Payable") ?? (coa2.Any(x => x.AccountNo == 2200) ? 2200 : null);
        var bankCharges = FindPdc("Bank Charges", "Bank Fees", "Charges") ?? (coa2.Any(x => x.AccountNo == 5200) ? 5200 : null);

        if (pdcRecv.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.PDC_RECEIVABLE, pdcRecv.Value);
        if (pdcPayClr.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.PDC_PAYABLE_CLEARING, pdcPayClr.Value);
        if (bankCharges.HasValue) await Roles.UpsertAsync(companyId, AccountRoleKeys.BANK_CHARGES, bankCharges.Value);
    }
}
