@page "/expense-create"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using UaeEInvoice.Data

@inject IDbContextFactory<AppDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<h1 class="mb-1">Create Expense</h1>
<p class="text-muted mb-4">Post an expense voucher (Debit Expense / Credit Cash or Payable).</p>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}
@if (!string.IsNullOrWhiteSpace(_success))
{
    <div class="alert alert-success">@_success</div>
}

<div class="card p-3 shadow-sm rounded-4">
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">Date</label>

            <!-- ✅ DateTime direct bind (NO string wrapper) -->
            <input type="date" class="form-control"
                   @bind-value="TxnDate"
                   @bind-value:format="yyyy-MM-dd" />
        </div>

        <div class="col-md-6">
            <label class="form-label">Narration</label>
            <input class="form-control" placeholder="Eg. Office rent / Transport / Stationery..."
                   @bind="Narration" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Amount</label>
            <input type="number" step="0.01" class="form-control text-end" @bind="Amount" />
        </div>

        <div class="col-md-6">
            <label class="form-label">Expense Account (Dr)</label>
            <select class="form-select" @bind="ExpenseAccountNo">
                <option value="0">-- Select Expense --</option>
                @foreach (var a in ExpenseAccounts)
                {
                    <option value="@a.AccountNo">@a.AccountName (@a.AccountNo)</option>
                }
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">Pay From / Payable Account (Cr)</label>
            <select class="form-select" @bind="PayAccountNo">
                <option value="0">-- Select Account --</option>
                @foreach (var a in PayAccounts)
                {
                    <option value="@a.AccountNo">@a.AccountName (@a.AccountNo)</option>
                }
            </select>
        </div>
    </div>

    <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-primary px-4" @onclick="SaveAsync" disabled="@_loading">
            Save Expense Voucher
        </button>
    </div>
</div>

@code {
    private bool _loading;
    private string? _error;
    private string? _success;

    private DateTime TxnDate = DateTime.Today;
    private string Narration = "";
    private decimal Amount = 0;

    private int ExpenseAccountNo;
    private int PayAccountNo;

    private List<CoaMini> ExpenseAccounts = new();
    private List<CoaMini> PayAccounts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAccountsAsync();
    }

    private async Task<int> GetLoggedInCompanyIdAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user?.Identity?.IsAuthenticated != true)
            return 0;

        var appUser = await UserManager.GetUserAsync(user);
        return appUser?.CompanyId ?? 0;
    }

    private async Task LoadAccountsAsync()
    {
        var companyId = await GetLoggedInCompanyIdAsync();
        if (companyId <= 0) { _error = "Company not detected."; return; }

        await using var db = await DbFactory.CreateDbContextAsync();

        var all = await db.Set<ChartOfAccount>()
            .AsNoTracking()
            .Where(a => a.CompanyId == companyId)
            .Select(a => new CoaMini { AccountNo = a.AccountNo, AccountName = a.AccountName })
            .OrderBy(a => a.AccountNo)
            .ToListAsync();

        ExpenseAccounts = all.Where(a => a.AccountNo >= 5000 && a.AccountNo < 6000).ToList();
        PayAccounts = all.Where(a =>
            (a.AccountNo >= 1000 && a.AccountNo < 2000) ||   // Cash/Bank
            (a.AccountNo >= 2000 && a.AccountNo < 3000)      // Payable
        ).ToList();
    }

    private static string NextVoucherNo(string? lastRefNo, DateTime dt)
    {
        var prefix = $"EXP-{dt:yyyyMM}-";
        var max = 0;

        if (!string.IsNullOrWhiteSpace(lastRefNo) && lastRefNo.StartsWith(prefix))
        {
            var tail = lastRefNo.Substring(prefix.Length);
            if (int.TryParse(tail, out var n)) max = n;
        }

        return prefix + (max + 1).ToString("00000");
    }

    private async Task SaveAsync()
    {
        _error = null;
        _success = null;
        _loading = true;

        try
        {
            var companyId = await GetLoggedInCompanyIdAsync();
            if (companyId <= 0) throw new Exception("Company not detected.");

            if (Amount <= 0) throw new Exception("Amount must be > 0.");
            if (ExpenseAccountNo <= 0) throw new Exception("Select Expense Account.");
            if (PayAccountNo <= 0) throw new Exception("Select Pay Account.");

            await using var db = await DbFactory.CreateDbContextAsync();

            var prefix = $"EXP-{TxnDate:yyyyMM}-";
            var last = await db.LedgerEntries
                .AsNoTracking()
                .Where(x => x.CompanyId == companyId && x.RefNo != null && x.RefNo.StartsWith(prefix))
                .OrderByDescending(x => x.RefNo)
                .Select(x => x.RefNo)
                .FirstOrDefaultAsync();

            var voucherNo = NextVoucherNo(last, TxnDate);

            db.LedgerEntries.Add(new LedgerEntry
                {
                    CompanyId = companyId,
                    TxnDate = TxnDate.Date,
                    AccountNo = ExpenseAccountNo,
                    Debit = Amount,
                    Credit = 0,
                    RefNo = voucherNo,
                    Narration = Narration
                });

            db.LedgerEntries.Add(new LedgerEntry
                {
                    CompanyId = companyId,
                    TxnDate = TxnDate.Date,
                    AccountNo = PayAccountNo,
                    Debit = 0,
                    Credit = Amount,
                    RefNo = voucherNo,
                    Narration = Narration
                });

            await db.SaveChangesAsync();

            _success = $"Saved: {voucherNo}";
            Nav.NavigateTo($"/voucher/{voucherNo}");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private sealed class CoaMini
    {
        public int AccountNo { get; set; }
        public string AccountName { get; set; } = "";
    }
}
