@page "/cashflow"
@using Microsoft.EntityFrameworkCore
@using UaeEInvoice.Data
@using UaeEInvoice.Services.Auth
@using Microsoft.AspNetCore.Authorization

@inject AppDbContext Db
@inject ICurrentCompany CurrentCompany

@attribute [Authorize(Roles = "Admin,Accounts,Finance")]

<div class="container-xxl py-4 cf">

    <!-- Header -->
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="cf-hero-icon">
                <!-- cashflow icon -->
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <path d="M4 14c2.2 0 3.5-1.6 5-1.6S12 14 14 14s3.3-1.6 5-1.6S22 14 22 14"
                          stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    <path d="M2 7h20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    <path d="M2 21h20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    <path d="M6 7v14M18 7v14" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                </svg>
            </div>

            <div>
                <h2 class="cf-title mb-1">Cash Flow</h2>
                <div class="text-muted">Real cash movement from General Ledger (Cash/Bank accounts only).</div>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="cf-pill d-none d-md-inline-flex">
                Period:
                <b class="ms-1">@_from.ToString("dd-MM-yyyy")</b>
                <span class="mx-2 text-muted">→</span>
                <b>@_to.ToString("dd-MM-yyyy")</b>
            </div>

            <button class="btn btn-outline-secondary cf-btn" type="button" @onclick="Reload" disabled="@_loading">
                @if (_loading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Loading...</span>
                }
                else
                {
                    <span>Reload</span>
                }
            </button>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger cf-alert">@_error</div>
    }

    <!-- Filters -->
    <div class="card cf-card mb-3">
        <div class="card-body p-3 p-md-4">
            <div class="row g-3 align-items-end">

                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label mb-1">From</label>
                    <div class="input-group cf-input">
                        <span class="input-group-text">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M7 3v3M17 3v3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                                <path d="M4 9h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                                <path d="M6 6h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z"
                                      stroke="currentColor" stroke-width="1.7" />
                            </svg>
                        </span>
                        <input type="date" class="form-control"
                               @bind-value="_from" @bind-value:event="onchange" />
                    </div>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label mb-1">To</label>
                    <div class="input-group cf-input">
                        <span class="input-group-text">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M7 3v3M17 3v3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                                <path d="M4 9h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                                <path d="M6 6h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z"
                                      stroke="currentColor" stroke-width="1.7" />
                            </svg>
                        </span>
                        <input type="date" class="form-control"
                               @bind-value="_to" @bind-value:event="onchange" />
                    </div>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label mb-1">Group By</label>
                    <select class="form-select cf-select" @bind="_groupBy">
                        <option value="Daily">Daily</option>
                        <option value="Monthly">Monthly</option>
                    </select>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-primary cf-btn flex-fill" type="button" @onclick="Apply" disabled="@_loading">Apply</button>
                        <button class="btn btn-outline-secondary cf-btn flex-fill" type="button" @onclick="Clear" disabled="@_loading">Clear</button>
                    </div>
                </div>

                <!-- Cash accounts -->
                <div class="col-12">
                    <label class="form-label mb-1">Cash/Bank Account Nos (comma separated)</label>
                    <div class="input-group cf-input">
                        <span class="input-group-text">
                            <!-- wallet icon -->
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M3 7h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3V7Z" stroke="currentColor" stroke-width="1.7" />
                                <path d="M3 7V6a2 2 0 0 1 2-2h14" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                                <path d="M17 13h4" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                            </svg>
                        </span>
                        <input class="form-control" placeholder="Example: 1000,1010"
                               @bind="_cashAccountsCsv" @bind:event="oninput" />
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-2 align-items-center">
                        <span class="cf-chip">
                            Cash Accounts Detected: <b class="ms-1">@_cashAccounts.Count</b>
                        </span>

                        <div class="form-check form-switch ms-md-2">
                            <input class="form-check-input" type="checkbox" role="switch" id="showTransfers"
                                   @bind="_showTransfers" />
                            <label class="form-check-label" for="showTransfers">Show transfers</label>
                        </div>

                        <div class="ms-auto text-muted small">
                            Transfers = Debit cash & Credit cash (no net impact)
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">

        <div class="col-12 col-md-6 col-lg">
            <div class="card cf-kpi k1 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="text-muted small">Opening Balance</div>
                    <div class="cf-kpi-val">@Opening.ToString("0.00")</div>
                    <div class="text-muted small">Before start date</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg">
            <div class="card cf-kpi k2 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="text-muted small">Cash In</div>
                    <div class="cf-kpi-val text-success">@CashIn.ToString("0.00")</div>
                    <div class="text-muted small">Debit cash/bank</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg">
            <div class="card cf-kpi k3 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="text-muted small">Cash Out</div>
                    <div class="cf-kpi-val text-danger">@CashOut.ToString("0.00")</div>
                    <div class="text-muted small">Credit cash/bank</div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg">
            <div class="card cf-kpi k4 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="text-muted small">Net Change</div>
                    <div class="cf-kpi-val @NetClass">@Net.ToString("0.00")</div>
                    <div class="text-muted small">In - Out</div>
                    <div class="cf-bar mt-3">
                        <div class="cf-bar-in" style="width:@InPct%"></div>
                        <div class="cf-bar-out" style="width:@OutPct%"></div>
                    </div>
                    <div class="d-flex justify-content-between text-muted small mt-2">
                        <span>In</span><span>Out</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6 col-lg">
            <div class="card cf-kpi k5 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="text-muted small">Closing Balance</div>
                    <div class="cf-kpi-val">@Closing.ToString("0.00")</div>
                    <div class="text-muted small">Opening + Net</div>
                </div>
            </div>
        </div>

    </div>

    <!-- Summary Table -->
    <div class="card cf-card mb-3">
        <div class="card-body p-0 position-relative">

            @if (_loading)
            {
                <div class="cf-loading">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    <span class="ms-2 fw-semibold">Loading cashflow…</span>
                </div>
            }

            <div class="cf-table-top px-3 px-md-4 py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="text-muted">
                    Showing: <b>@_groups.Count</b> @_groupBy groups
                </div>
                <div class="text-muted">
                    Movements: <b>@MovementsShown</b>
                </div>
            </div>

            <div class="table-responsive cf-table-wrap">
                <table class="table cf-table align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="min-width:230px;">@(_groupBy == "Monthly" ? "Month" : "Date")</th>
                            <th style="min-width:260px;">Top Voucher Types</th>
                            <th class="text-end" style="width:160px;">Cash In</th>
                            <th class="text-end" style="width:160px;">Cash Out</th>
                            <th class="text-end" style="width:160px;">Net</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (_loading)
                        {
                            @for (int i = 0; i < 6; i++)
                            {
                                <tr>
                                    <td><div class="skeleton sk w-60"></div></td>
                                    <td><div class="skeleton sk w-80"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                </tr>
                            }
                        }
                        else
                        {
                            @foreach (var g in _groups)
                            {
                                var net = g.In - g.Out;
                                <tr>
                                    <td class="fw-semibold">@g.Label</td>

                                    <td>
                                        <div class="d-flex flex-wrap gap-2">
                                            @foreach (var c in g.TopLabels)
                                            {
                                                <span class="badge rounded-pill cf-tag">@c</span>
                                            }
                                        </div>
                                    </td>

                                    <td class="text-end fw-semibold text-success">@g.In.ToString("0.00")</td>
                                    <td class="text-end fw-semibold text-danger">@g.Out.ToString("0.00")</td>

                                    <td class="text-end fw-bold @(net >= 0 ? "text-success" : "text-danger")">
                                        @net.ToString("0.00")
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>

                @if (_groups.Count == 0 && !_loading)
                {
                    <div class="text-center text-muted py-5">
                        <div class="fw-semibold">No cash movements found.</div>
                        <div class="small">Check Cash/Bank Account Nos or change date range.</div>
                    </div>
                }
            </div>

        </div>
    </div>

    <!-- Detail Transactions -->
    <div class="card cf-card">
        <div class="card-body p-0">

            <div class="cf-table-top px-3 px-md-4 py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="text-muted">Details (latest first)</div>
                <div class="text-muted small">
                    Transfers shown: <b>@(_showTransfers ? "Yes" : "No")</b>
                </div>
            </div>

            <div class="table-responsive cf-table-wrap">
                <table class="table cf-table align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="min-width:140px;">Date</th>
                            <th style="min-width:120px;">Voucher</th>
                            <th style="min-width:140px;">No</th>
                            <th style="min-width:260px;">Narration</th>
                            <th class="text-end" style="width:150px;">In</th>
                            <th class="text-end" style="width:150px;">Out</th>
                            <th class="text-end" style="width:160px;">Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var m in _movesShown)
                        {
                            <tr>
                                <td>@m.Date.ToString("dd-MM-yyyy")</td>
                                <td class="fw-semibold">@m.VoucherType</td>
                                <td>@m.VoucherNo</td>
                                <td class="text-muted">@m.Narration</td>
                                <td class="text-end text-success fw-semibold">@m.In.ToString("0.00")</td>
                                <td class="text-end text-danger fw-semibold">@m.Out.ToString("0.00")</td>
                                <td class="text-end">
                                    <span class="badge rounded-pill @MoveBadge(m.Kind)">
                                        @m.Kind
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                @if (_movesShown.Count == 0 && !_loading)
                {
                    <div class="text-center text-muted py-5">
                        <div class="fw-semibold">No transactions to show.</div>
                    </div>
                }
            </div>

        </div>
    </div>

</div>

<style>
    .cf {
        --r: 18px;
    }

    .cf-title {
        font-weight: 950;
        letter-spacing: .2px;
    }

    .cf-hero-icon {
        width: 46px;
        height: 46px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: rgba(13,110,253,.10);
        color: var(--bs-primary);
        border: 1px solid rgba(13,110,253,.18);
        box-shadow: 0 12px 28px rgba(0,0,0,.08);
    }

    .cf-pill {
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(0,0,0,.03);
        border: 1px solid rgba(0,0,0,.06);
    }

    .cf-btn {
        border-radius: 14px;
        padding: 10px 16px;
        font-weight: 650;
    }

    .cf-card {
        border-radius: var(--r);
        border: 1px solid rgba(0,0,0,.06);
        box-shadow: 0 12px 30px rgba(0,0,0,.06);
        overflow: hidden;
        background: #fff;
    }

    .cf-alert {
        border-radius: var(--r);
        border: 1px solid rgba(220,53,69,.25);
        box-shadow: 0 12px 30px rgba(0,0,0,.06);
    }

    .cf-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,.08);
        background: rgba(0,0,0,.02);
        width: fit-content;
        font-weight: 600;
    }

    .cf-input .input-group-text {
        border-radius: 14px 0 0 14px;
        background: rgba(0,0,0,.02);
        border-color: rgba(0,0,0,.08);
        color: rgba(0,0,0,.65);
    }

    .cf-input .form-control {
        border-radius: 0 14px 14px 0;
        border-color: rgba(0,0,0,.08);
        padding-top: 11px;
        padding-bottom: 11px;
    }

    .cf-select {
        border-radius: 14px;
        border-color: rgba(0,0,0,.08);
        padding-top: 11px;
        padding-bottom: 11px;
    }

    .cf-kpi {
        border-radius: var(--r);
        border: 1px solid rgba(0,0,0,.06);
        box-shadow: 0 12px 30px rgba(0,0,0,.06);
        overflow: hidden;
    }

    .cf-kpi-val {
        font-size: 36px;
        font-weight: 950;
        letter-spacing: .3px;
        line-height: 1.05;
        margin-top: 6px;
        margin-bottom: 4px;
    }

    .k1 {
        background: linear-gradient(135deg, rgba(13,110,253,.14), rgba(13,110,253,.04));
    }

    .k2 {
        background: linear-gradient(135deg, rgba(25,135,84,.14), rgba(25,135,84,.04));
    }

    .k3 {
        background: linear-gradient(135deg, rgba(220,53,69,.14), rgba(220,53,69,.04));
    }

    .k4 {
        background: linear-gradient(135deg, rgba(255,193,7,.16), rgba(255,193,7,.04));
    }

    .k5 {
        background: linear-gradient(135deg, rgba(111,66,193,.14), rgba(111,66,193,.04));
    }

    .cf-bar {
        height: 10px;
        border-radius: 999px;
        overflow: hidden;
        background: rgba(0,0,0,.06);
        display: flex;
    }

    .cf-bar-in {
        background: rgba(25,135,84,.65);
    }

    .cf-bar-out {
        background: rgba(220,53,69,.65);
    }

    .cf-table-top {
        background: rgba(0,0,0,.02);
        border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .cf-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #fff;
        border-bottom: 1px solid rgba(0,0,0,.08);
        text-transform: uppercase;
        letter-spacing: .10em;
        font-size: .75rem;
        color: rgba(0,0,0,.55);
        padding: 14px 16px;
        white-space: nowrap;
    }

    .cf-table tbody td {
        border-color: rgba(0,0,0,.06);
        padding: 14px 16px;
        vertical-align: middle;
    }

    .cf-table tbody tr:hover {
        background: rgba(13,110,253,.04);
    }

    .cf-tag {
        background: rgba(13,110,253,.08);
        color: rgba(13,110,253,1);
        border: 1px solid rgba(13,110,253,.18);
        font-weight: 750;
        padding: 7px 10px;
    }

    .cf-loading {
        position: absolute;
        right: 16px;
        top: 14px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,.90);
        border: 1px solid rgba(0,0,0,.08);
        box-shadow: 0 10px 22px rgba(0,0,0,.10);
        z-index: 10;
        backdrop-filter: blur(6px);
        display: flex;
        align-items: center;
    }

    .skeleton {
        display: inline-block;
        border-radius: 12px;
        height: 14px;
        background: linear-gradient(90deg, rgba(0,0,0,.05), rgba(0,0,0,.09), rgba(0,0,0,.05));
        background-size: 220% 100%;
        animation: sk 1.15s infinite;
    }

    .w-50 {
        width: 50%;
    }

    .w-60 {
        width: 60%;
    }

    .w-80 {
        width: 80%;
    }

    @@keyframes sk {
        0% {
            background-position: 220% 0;
        }

        100% {
            background-position: -220% 0;
        }
    }
</style>

@code {
    private int _companyId;
    private bool _loading;
    private string? _error;

    private DateTime _from = DateTime.Today.AddDays(-30);
    private DateTime _to = DateTime.Today;
    private string _groupBy = "Daily";

    private string _cashAccountsCsv = "1000,1010";
    private HashSet<int> _cashAccounts = new();

    private bool _showTransfers = false;

    private decimal Opening { get; set; }
    private decimal CashIn { get; set; }
    private decimal CashOut { get; set; }
    private decimal Net => CashIn - CashOut;
    private decimal Closing => Opening + Net;

    private string NetClass => Net >= 0 ? "text-success" : "text-danger";
    private int MovementsShown => _movesShown.Count;

    private decimal InPct => CalcPct(CashIn, CashOut);
    private decimal OutPct => 100 - InPct;

    private List<CashMove> _movesAll = new();
    private List<CashMove> _movesShown = new();
    private List<CashGroup> _groups = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _companyId = await GetCompanyIdSafe();
            if (_companyId <= 0)
                throw new Exception("Company not selected / not found. Please select a company.");

            await Load();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task<int> GetCompanyIdSafe()
    {
        try
        {
            var method = CurrentCompany.GetType().GetMethod("GetCompanyIdAsync");
            if (method != null)
            {
                var task = (Task<int>)method.Invoke(CurrentCompany, null)!;
                return await task;
            }
        }
        catch { }

        try
        {
            var prop = CurrentCompany.GetType().GetProperty("CompanyId");
            if (prop != null)
            {
                var val = prop.GetValue(CurrentCompany);
                if (val is int id) return id;
            }
        }
        catch { }

        return 0;
    }

    private async Task Reload() => await Load();
    private async Task Apply() => await Load();

    private async Task Clear()
    {
        _from = DateTime.Today.AddDays(-30);
        _to = DateTime.Today;
        _groupBy = "Daily";
        await Load();
    }

    private decimal CalcPct(decimal a, decimal b)
    {
        var total = a + b;
        if (total <= 0) return 50;
        return Math.Round((a / total) * 100, 0);
    }

    private static HashSet<int> ParseAccounts(string csv)
    {
        var set = new HashSet<int>();
        if (string.IsNullOrWhiteSpace(csv)) return set;

        var parts = csv.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var p in parts)
            if (int.TryParse(p, out var n)) set.Add(n);

        return set;
    }

    private async Task Load()
    {
        _loading = true;
        _error = null;

        try
        {
            _companyId = await GetCompanyIdSafe();
            if (_companyId <= 0)
                throw new Exception("Company not selected / not found. Please select a company.");

            if (_from > _to)
                throw new Exception("From date cannot be greater than To date.");

            _cashAccounts = ParseAccounts(_cashAccountsCsv);
            if (_cashAccounts.Count == 0)
                throw new Exception("Please enter at least one Cash/Bank Account No (example: 1000,1010).");

            var fromDate = _from.Date;
            var toExclusive = _to.Date.AddDays(1);

            // ✅ FAST opening balance (no ToList)
            var openIn = await Db.GeneralLedgerEntries.AsNoTracking()
                .Where(x => x.CompanyId == _companyId && x.TxnDate < fromDate)
                .Where(x => _cashAccounts.Contains(x.DebitAccountNo) && !_cashAccounts.Contains(x.CreditAccountNo))
                .SumAsync(x => (decimal?)x.Amount) ?? 0m;

            var openOut = await Db.GeneralLedgerEntries.AsNoTracking()
                .Where(x => x.CompanyId == _companyId && x.TxnDate < fromDate)
                .Where(x => _cashAccounts.Contains(x.CreditAccountNo) && !_cashAccounts.Contains(x.DebitAccountNo))
                .SumAsync(x => (decimal?)x.Amount) ?? 0m;

            Opening = openIn - openOut;

            // Movements in range
            var rangeRows = await Db.GeneralLedgerEntries.AsNoTracking()
                .Where(x => x.CompanyId == _companyId && x.TxnDate >= fromDate && x.TxnDate < toExclusive)
                .Where(x => _cashAccounts.Contains(x.DebitAccountNo) || _cashAccounts.Contains(x.CreditAccountNo))
                .OrderByDescending(x => x.TxnDate)
                .ToListAsync();

            _movesAll = BuildMoves(rangeRows, _cashAccounts);

            _movesShown = _showTransfers
                ? _movesAll
                : _movesAll.Where(x => x.Kind != "Transfer").ToList();

            CashIn = _movesShown.Sum(x => x.In);
            CashOut = _movesShown.Sum(x => x.Out);

            _groups = BuildGroups(_movesShown, _groupBy);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            Opening = CashIn = CashOut = 0;
            _movesAll = new();
            _movesShown = new();
            _groups = new();
        }
        finally
        {
            _loading = false;
        }
    }

    private List<CashMove> BuildMoves(List<GeneralLedgerEntry> rows, HashSet<int> cashAccounts)
    {
        var list = new List<CashMove>();

        foreach (var e in rows)
        {
            var debitIsCash = cashAccounts.Contains(e.DebitAccountNo);
            var creditIsCash = cashAccounts.Contains(e.CreditAccountNo);

            if (!debitIsCash && !creditIsCash) continue;

            if (debitIsCash && !creditIsCash)
            {
                list.Add(new CashMove
                    {
                        Date = e.TxnDate,
                        VoucherType = VoucherLabel(e.VoucherType),
                        VoucherNo = e.VoucherNo,
                        Narration = ShortNarr(e.Narration) ?? $"From A/c {e.CreditAccountNo}",
                        In = e.Amount,
                        Out = 0,
                        Kind = "In"
                    });
            }
            else if (creditIsCash && !debitIsCash)
            {
                list.Add(new CashMove
                    {
                        Date = e.TxnDate,
                        VoucherType = VoucherLabel(e.VoucherType),
                        VoucherNo = e.VoucherNo,
                        Narration = ShortNarr(e.Narration) ?? $"To A/c {e.DebitAccountNo}",
                        In = 0,
                        Out = e.Amount,
                        Kind = "Out"
                    });
            }
            else
            {
                list.Add(new CashMove
                    {
                        Date = e.TxnDate,
                        VoucherType = VoucherLabel(e.VoucherType),
                        VoucherNo = e.VoucherNo,
                        Narration = ShortNarr(e.Narration) ?? $"Transfer {e.CreditAccountNo} → {e.DebitAccountNo}",
                        In = 0,
                        Out = 0,
                        Kind = "Transfer"
                    });
            }
        }

        return list.OrderByDescending(x => x.Date).ToList();
    }

    private static string? ShortNarr(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) return null;
        s = s.Trim();
        return s.Length <= 110 ? s : s.Substring(0, 110) + "…";
    }

    private List<CashGroup> BuildGroups(List<CashMove> moves, string groupBy)
    {
        if (groupBy == "Monthly")
        {
            return moves
                .GroupBy(x => new DateTime(x.Date.Year, x.Date.Month, 1))
                .OrderByDescending(g => g.Key)
                .Select(g => MakeGroup(g.Key.ToString("MMM yyyy"), g.ToList()))
                .ToList();
        }

        return moves
            .GroupBy(x => x.Date.Date)
            .OrderByDescending(g => g.Key)
            .Select(g => MakeGroup(g.Key.ToString("dd MMM yyyy"), g.ToList()))
            .ToList();
    }

    private CashGroup MakeGroup(string label, List<CashMove> list)
    {
        var top = list
            .Where(x => x.Kind != "Transfer")
            .GroupBy(x => x.VoucherTypeRaw)
            .OrderByDescending(g => g.Sum(z => z.In + z.Out))
            .Take(3)
            .Select(g => VoucherLabel(g.Key))
            .ToList();

        if (top.Count == 0) top = new List<string> { "Transfer" };

        return new CashGroup
            {
                Label = label,
                In = list.Sum(x => x.In),
                Out = list.Sum(x => x.Out),
                TopLabels = top
            };
    }

    // ✅ Voucher labels (added CPB + PC)
    private static string VoucherLabel(string v) => v switch
    {
        "INV" => "Sales Invoice",
        "REC" => "Receipt",
        "PINV" => "Purchase Invoice",
        "PPAY" => "Purchase Payment",
        "CPB" => "Construction Purchase Bill",
        "PC" => "Subcontractor PC",
        _ => v
    };

    private string MoveBadge(string kind) => kind switch
    {
        "In" => "bg-success-subtle text-success border border-success-subtle",
        "Out" => "bg-danger-subtle text-danger border border-danger-subtle",
        _ => "bg-secondary-subtle text-secondary border border-secondary-subtle"
    };

    private class CashMove
    {
        public DateTime Date { get; set; }

        // Display label
        public string VoucherType { get; set; } = "";

        // Raw for grouping
        public string VoucherTypeRaw { get; set; } = "";

        public string VoucherNo { get; set; } = "";
        public string Narration { get; set; } = "";
        public decimal In { get; set; }
        public decimal Out { get; set; }
        public string Kind { get; set; } = ""; // In/Out/Transfer
    }

    private class CashGroup
    {
        public string Label { get; set; } = "";
        public decimal In { get; set; }
        public decimal Out { get; set; }
        public List<string> TopLabels { get; set; } = new();
    }
}
