@page "/inventory"
@using Microsoft.EntityFrameworkCore
@using UaeEInvoice.Data
@using UaeEInvoice.Services.Auth
@inject AppDbContext Db
@inject NavigationManager Nav
@inject ICurrentCompany CurrentCompany
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin,Inventory")]

<div class="container-xxl py-4 inv">

    <!-- Top Bar -->
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="inv-hero-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                    <path d="M21 8.5V16.2c0 .6-.3 1.2-.9 1.5l-7 3.8c-.7.4-1.5.4-2.2 0l-7-3.8c-.6-.3-.9-.9-.9-1.5V8.5"
                          stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    <path d="M21 8.5l-9 4.9-9-4.9 9-4.9 9 4.9Z"
                          stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" />
                    <path d="M12 13.4V21" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                </svg>
            </div>

            <div>
                <h2 class="inv-title mb-1">Inventory</h2>
                <div class="text-muted">Stock on hand, average cost, valuation (from Stock Ledger).</div>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="inv-pill d-none d-md-inline-flex">
                As of <b class="ms-1">@_asOfDate.ToString("dd-MM-yyyy")</b>
            </div>

            <button class="btn btn-outline-secondary inv-btn" type="button" @onclick="Reload" disabled="@_loading">
                @if (_loading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Loading...</span>
                }
                else
                {
                    <span>Reload</span>
                }
            </button>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger inv-alert">
            @_error
        </div>
    }

    <!-- Filters -->
    <div class="card inv-card mb-3">
        <div class="card-body p-3 p-md-4">
            <div class="row g-3 align-items-end">

                <!-- Search -->
                <div class="col-12 col-lg-6">
                    <label class="form-label mb-1">Search Item</label>
                    <div class="input-group inv-input">
                        <span class="input-group-text">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z" stroke="currentColor" stroke-width="1.7" />
                                <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                            </svg>
                        </span>
                        <input class="form-control" placeholder="Type item name..."
                               @bind="_q" @bind:event="oninput" />
                    </div>
                @*     <div class="form-text">Tip: Use partial name (ex: “iphone”, “iron”).</div> *@
                </div>

                <!-- Date -->
                <div class="col-12 col-md-6 col-lg-3">
                    <label class="form-label mb-1">As of Date</label>
                    <div class="input-group inv-input">
                        <span class="input-group-text">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M7 3v3M17 3v3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                                <path d="M4 9h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                                <path d="M6 6h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z"
                                      stroke="currentColor" stroke-width="1.7" />
                            </svg>
                        </span>
                        <input type="date" class="form-control"
                               @bind-value="_asOfDate" @bind-value:event="onchange" />
                    </div>
                </div>

                <!-- Buttons -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-primary inv-btn flex-fill" type="button"
                                @onclick="ApplyFilters" disabled="@_loading">
                            Apply
                        </button>
                        <button class="btn btn-outline-secondary inv-btn flex-fill" type="button"
                                @onclick="ClearFilters" disabled="@_loading">
                            Clear
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- KPI Row -->
    <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
            <div class="card inv-kpi k1 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <div class="text-muted small">Items (shown)</div>
                            <div class="inv-kpi-val">@_rows.Count</div>
                            <div class="text-muted small">Unique items</div>
                        </div>
                        <div class="inv-kpi-ic">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="card inv-kpi k2 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <div class="text-muted small">Total On Hand Qty</div>
                            <div class="inv-kpi-val">@_rows.Sum(x => x.OnHandQty).ToString("0.##")</div>
                            <div class="text-muted small">Current stock</div>
                        </div>
                        <div class="inv-kpi-ic">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="card inv-kpi k3 h-100">
                <div class="card-body p-3 p-md-4">
                    <div class="d-flex align-items-start justify-content-between">
                        <div>
                            <div class="text-muted small">Estimated Stock Value</div>
                            <div class="inv-kpi-val">@_rows.Sum(x => x.StockValue).ToString("0.00")</div>
                            <div class="text-muted small">OnHand × AvgCost</div>
                            <div class="text-muted small mt-2">
                                AvgCost is based on <b>PURCHASE</b> entries.
                            </div>
                        </div>
                        <div class="inv-kpi-ic">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M7 7h10v10H7z" stroke="currentColor" stroke-width="1.7" />
                                <path d="M4 10V4h6" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="card inv-card">
        <div class="card-body p-0 position-relative">

            @if (_loading)
            {
                <div class="inv-loading">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span class="ms-2 fw-semibold">Loading inventory…</span>
                </div>
            }

            <div class="inv-table-top px-3 px-md-4 py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="text-muted">Showing: <b>@_rows.Count</b></div>
                <div class="text-muted">As of: <b>@_asOfDate.ToString("dd-MM-yyyy")</b></div>
            </div>

            <div class="table-responsive inv-table-wrap">
                <table class="table inv-table align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="min-width:260px;">Item</th>
                            <th class="text-end" style="width:120px;">In Qty</th>
                            <th class="text-end" style="width:120px;">Out Qty</th>
                            <th class="text-end" style="width:140px;">On Hand</th>
                            <th class="text-end" style="width:140px;">Avg Cost</th>
                            <th class="text-end" style="width:160px;">Stock Value</th>
                        </tr>
                    </thead>

                    <tbody>
                        @if (_loading)
                        {
                            @for (int i = 0; i < 7; i++)
                            {
                                <tr>
                                    <td><div class="skeleton sk w-75"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                    <td class="text-end"><div class="skeleton sk w-50 ms-auto"></div></td>
                                </tr>
                            }
                        }
                        else
                        {
                            @foreach (var r in _rows)
                            {
                                <tr>
                                    <td class="fw-semibold">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="inv-dot"></span>
                                            <span>@r.ItemName</span>
                                        </div>
                                    </td>

                                    <td class="text-end text-success fw-semibold">@r.InQty.ToString("0.##")</td>
                                    <td class="text-end text-danger fw-semibold">@r.OutQty.ToString("0.##")</td>

                                    <td class="text-end">
                                        <span class="badge rounded-pill @OnHandBadge(r.OnHandQty) inv-badge">
                                            @r.OnHandQty.ToString("0.##")
                                        </span>
                                    </td>

                                    <td class="text-end">@r.AvgCost.ToString("0.00")</td>

                                    <td class="text-end fw-bold">
                                        @r.StockValue.ToString("0.00")
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>

                @if (_rows.Count == 0 && !_loading)
                {
                    <div class="text-center text-muted py-5">
                        <div class="fw-semibold">No stock ledger entries found.</div>
                        <div class="small">Try changing date or clearing search filter.</div>
                    </div>
                }
            </div>

        </div>
    </div>

</div>

<style>
    /* ===== Premium Inventory UI ===== */
    .inv {
        --r: 18px;
    }

    .inv-title {
        font-weight: 850;
        letter-spacing: .2px;
    }

    .inv-hero-icon {
        width: 46px;
        height: 46px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: rgba(13,110,253,.10);
        color: var(--bs-primary);
        border: 1px solid rgba(13,110,253,.18);
        box-shadow: 0 10px 26px rgba(0,0,0,.08);
    }

    .inv-pill {
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(0,0,0,.03);
        border: 1px solid rgba(0,0,0,.06);
    }

    .inv-btn {
        border-radius: 14px;
        padding: 10px 16px;
        font-weight: 600;
    }

    .inv-card {
        border-radius: var(--r);
        border: 1px solid rgba(0,0,0,.06);
        box-shadow: 0 12px 30px rgba(0,0,0,.06);
        overflow: hidden;
        background: #fff;
    }

    .inv-alert {
        border-radius: var(--r);
        border: 1px solid rgba(220,53,69,.25);
        box-shadow: 0 12px 30px rgba(0,0,0,.06);
    }

    .inv-input .input-group-text {
        border-radius: 14px 0 0 14px;
        background: rgba(0,0,0,.02);
        border-color: rgba(0,0,0,.08);
        color: rgba(0,0,0,.65);
    }

    .inv-input .form-control {
        border-radius: 0 14px 14px 0;
        border-color: rgba(0,0,0,.08);
        padding-top: 11px;
        padding-bottom: 11px;
    }

    .inv-kpi {
        border-radius: var(--r);
        border: 1px solid rgba(0,0,0,.06);
        box-shadow: 0 12px 30px rgba(0,0,0,.06);
        overflow: hidden;
    }

    .inv-kpi-val {
        font-size: 40px;
        font-weight: 900;
        letter-spacing: .3px;
        line-height: 1.05;
        margin-top: 6px;
        margin-bottom: 4px;
    }

    .inv-kpi-ic {
        width: 42px;
        height: 42px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: rgba(255,255,255,.55);
        border: 1px solid rgba(255,255,255,.55);
    }

    .k1 {
        background: linear-gradient(135deg, rgba(13,110,253,.14), rgba(13,110,253,.04));
    }

    .k2 {
        background: linear-gradient(135deg, rgba(25,135,84,.14), rgba(25,135,84,.04));
    }

    .k3 {
        background: linear-gradient(135deg, rgba(111,66,193,.14), rgba(111,66,193,.04));
    }

    .inv-table-top {
        background: rgba(0,0,0,.02);
        border-bottom: 1px solid rgba(0,0,0,.06);
    }

    .inv-table-wrap {
        overflow: hidden;
    }

    .inv-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #fff;
        border-bottom: 1px solid rgba(0,0,0,.08);
        text-transform: uppercase;
        letter-spacing: .10em;
        font-size: .75rem;
        color: rgba(0,0,0,.55);
        padding: 14px 16px;
        white-space: nowrap;
    }

    .inv-table tbody td {
        border-color: rgba(0,0,0,.06);
        padding: 14px 16px;
        vertical-align: middle;
    }

    .inv-table tbody tr:hover {
        background: rgba(13,110,253,.04);
    }

    .inv-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(13,110,253,.65);
        box-shadow: 0 0 0 6px rgba(13,110,253,.10);
        flex: 0 0 auto;
    }

    .inv-badge {
        padding: 8px 12px;
        font-weight: 800;
        border: 1px solid rgba(0,0,0,.08);
        min-width: 46px;
        display: inline-flex;
        justify-content: center;
    }

    .inv-loading {
        position: absolute;
        right: 16px;
        top: 14px;
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255,255,255,.85);
        border: 1px solid rgba(0,0,0,.08);
        box-shadow: 0 10px 22px rgba(0,0,0,.10);
        z-index: 10;
        backdrop-filter: blur(6px);
        display: flex;
        align-items: center;
    }

    .skeleton {
        display: inline-block;
        border-radius: 12px;
        height: 14px;
        background: linear-gradient(90deg, rgba(0,0,0,.05), rgba(0,0,0,.09), rgba(0,0,0,.05));
        background-size: 220% 100%;
        animation: sk 1.15s infinite;
    }

    .sk {
        height: 14px;
    }

    @@keyframes sk {
        0% {
            background-position: 220% 0;
        }

        100% {
            background-position: -220% 0;
        }
    }
</style>

@code {
    private int _companyId;
    private bool _loading = false;
    private string? _error;

    private string _q = "";
    private DateTime _asOfDate = DateTime.Today;

    private List<RowVm> _rows = new();

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        _error = null;

        try
        {
            await CurrentCompany.RefreshAsync();

            if (!CurrentCompany.IsAuthenticated)
                throw new Exception("Not authenticated. Logout and login again.");

            _companyId = CurrentCompany.CompanyId;

            if (_companyId <= 0)
                throw new Exception("CompanyId claim not found. Logout and login again.");

            await Load();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Reload()
    {
        _error = null;
        await Load();
    }

    private async Task ApplyFilters() => await Load();

    private async Task ClearFilters()
    {
        _q = "";
        _asOfDate = DateTime.Today;
        await Load();
    }

    private string OnHandBadge(decimal onHand)
    {
        if (onHand <= 0) return "bg-danger-subtle text-danger";
        if (onHand <= 2) return "bg-warning-subtle text-warning";
        return "bg-success-subtle text-success";
    }

    private async Task Load()
    {
        _loading = true;
        _error = null;

        try
        {
            var to = _asOfDate.Date.AddDays(1).AddTicks(-1);

            var led = Db.StockLedgers.AsNoTracking()
                .Where(x => x.CompanyId == _companyId && x.TxnDate <= to);

            if (!string.IsNullOrWhiteSpace(_q))
            {
                var s = _q.Trim();
                led = led.Where(x => x.ItemName.Contains(s));
            }

            var raw = await led
                .GroupBy(x => new { x.ItemId, x.ItemName })
                .Select(g => new
                {
                    g.Key.ItemId,
                    g.Key.ItemName,

                    OnHandQty = g.Sum(x => x.QtyChange),

                    InQty = g.Where(x => x.QtyChange > 0).Sum(x => x.QtyChange),
                    OutQty = g.Where(x => x.QtyChange < 0).Sum(x => -x.QtyChange),

                    PurchaseQty = g.Where(x => x.TxnType == "PURCHASE" && x.QtyChange > 0).Sum(x => x.QtyChange),
                    PurchaseValue = g.Where(x => x.TxnType == "PURCHASE" && x.QtyChange > 0)
                                     .Sum(x => x.QtyChange * x.UnitCost)
                })
                .OrderBy(x => x.ItemName)
                .ToListAsync();

            _rows = raw.Select(x =>
            {
                var avg = x.PurchaseQty > 0 ? (x.PurchaseValue / x.PurchaseQty) : 0m;
                var value = x.OnHandQty * avg;

                return new RowVm
                    {
                        ItemId = x.ItemId,
                        ItemName = x.ItemName,
                        InQty = x.InQty,
                        OutQty = x.OutQty,
                        OnHandQty = x.OnHandQty,
                        AvgCost = avg,
                        StockValue = value
                    };
            }).ToList();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private class RowVm
    {
        public int ItemId { get; set; }
        public string ItemName { get; set; } = "";
        public decimal InQty { get; set; }
        public decimal OutQty { get; set; }
        public decimal OnHandQty { get; set; }
        public decimal AvgCost { get; set; }
        public decimal StockValue { get; set; }
    }
}
