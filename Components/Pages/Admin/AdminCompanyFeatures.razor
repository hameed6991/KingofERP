@page "/admin/company-features"
@attribute [Authorize(Roles = "Admin")]

@using Microsoft.EntityFrameworkCore
@using UaeEInvoice.Data
@using UaeEInvoice.Services.Auth
@inject IDbContextFactory<AppDbContext> DbFactory

<h3 class="mb-1">Company Features (Owner Config)</h3>
<div class="text-muted mb-3">Enable/Disable modules per company. Customers cannot edit this.</div>

@if (!string.IsNullOrWhiteSpace(_err))
{
    <div class="alert alert-danger">@_err</div>
}
@if (!string.IsNullOrWhiteSpace(_msg))
{
    <div class="alert alert-success">@_msg</div>
}

<div class="card p-3 rounded-4">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-6">
            <label class="form-label">Select Company</label>
            <select class="form-select" @bind="_selectedCompanyId">
                <option value="0">-- Select Company --</option>
                @foreach (var c in _companies)
                {
                    <option value="@c.CompanyId">
                        @(string.IsNullOrWhiteSpace(c.ShortName) ? c.LegalName : $"{c.ShortName} - {c.LegalName}")
                    </option>
                }
            </select>
        </div>

        <div class="col-12 col-md-3">
            <button class="btn btn-primary w-100" @onclick="Load" disabled="@(_selectedCompanyId==0 || _loading)">
                @(_loading ? "Loading..." : "Load")
            </button>
        </div>
    </div>
</div>

@if (_selectedCompanyId > 0 && _loaded)
{
    <div class="card p-3 rounded-4 mt-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            <div class="fw-semibold">Enabled Modules</div>

            <button class="btn btn-success" @onclick="Save" disabled="@_saving">
                @(_saving ? "Saving..." : "Save Changes")
            </button>
        </div>

        <div class="row g-2">
            @foreach (var row in _rows)
            {
                <div class="col-12 col-md-6">
                    <div class="border rounded-4 p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-semibold">@GetLabel(row.FeatureKey)</div>
                            <div class="text-muted small">@row.FeatureKey</div>
                        </div>

                        <div class="form-check form-switch m-0">
                            <input class="form-check-input" type="checkbox" @bind="row.IsEnabled" />
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    private string? _err;
    private string? _msg;
    private bool _loading;
    private bool _saving;
    private bool _loaded;

    private int _selectedCompanyId = 0;

    private List<Company> _companies = new();
    private List<CompanyFeature> _rows = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
    }

    private async Task LoadCompanies()
    {
        _err = _msg = null;
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            _companies = await db.Companies.AsNoTracking()
                .OrderByDescending(x => x.CompanyId)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _err = ex.InnerException?.Message ?? ex.Message;
        }
    }

    private async Task Load()
    {
        _err = _msg = null;
        _loading = true;
        _loaded = false;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            await CompanyFeatureService.EnsureDefaultsAsync(db, _selectedCompanyId);

            _rows = await db.CompanyFeatures
                .Where(x => x.CompanyId == _selectedCompanyId)
                .OrderBy(x => x.FeatureKey)
                .ToListAsync();

            _loaded = true;
        }
        catch (Exception ex)
        {
            _err = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Save()
    {
        _err = _msg = null;
        _saving = true;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            var dbRows = await db.CompanyFeatures
                .Where(x => x.CompanyId == _selectedCompanyId)
                .ToListAsync();

            var map = dbRows.ToDictionary(x => x.FeatureKey, x => x, StringComparer.OrdinalIgnoreCase);

            foreach (var ui in _rows)
            {
                if (map.TryGetValue(ui.FeatureKey, out var entity))
                {
                    entity.IsEnabled = ui.IsEnabled;
                    entity.UpdatedAt = DateTime.UtcNow;
                }
                else
                {
                    db.CompanyFeatures.Add(new CompanyFeature
                        {
                            CompanyId = _selectedCompanyId,
                            FeatureKey = ui.FeatureKey,
                            IsEnabled = ui.IsEnabled,
                            UpdatedAt = DateTime.UtcNow
                        });
                }
            }

            await db.SaveChangesAsync();

            _rows = await db.CompanyFeatures
                .Where(x => x.CompanyId == _selectedCompanyId)
                .OrderBy(x => x.FeatureKey)
                .ToListAsync();

            _msg = "Saved successfully ✅";
        }
        catch (Exception ex)
        {
            _err = ex.InnerException?.Message ?? ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    private static string GetLabel(string key) => key switch
    {
        FeatureKeys.MASTERS => "Masters",
        FeatureKeys.SALES => "Sales",
        FeatureKeys.PURCHASE => "Purchase",
        FeatureKeys.ACCOUNTING => "Accounting",

        FeatureKeys.CHEQUES => "Cheques / PDC", // ✅ NEW

        FeatureKeys.AI => "AI Features",
        FeatureKeys.ADMIN => "Admin",
        FeatureKeys.REPORTS => "Reports",
        FeatureKeys.CRM => "CRM",
        FeatureKeys.BI => "Insights & Analytics (BI)",
        FeatureKeys.COMPANY_SETUP => "Company Setup",
        FeatureKeys.HOME => "Home",
        _ => key
    };
}
