@page "/ledger/{AccountNo:int}"
@using Microsoft.EntityFrameworkCore
@using UaeEInvoice.Services.Auth
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject ICurrentCompany CurrentCompany

<h1 class="display-6 fw-bold">General Ledger</h1>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<div class="card p-3 shadow-sm rounded-4 mb-3">
    <div class="row g-3 align-items-end">
        <div class="col-md-5">
            <label class="form-label">Account</label>
            <select class="form-select" value="@SelectedAccountNo" @onchange="AccountChanged">
                @foreach (var a in Accounts)
                {
                    <option value="@a.AccountNo">@a.AccountName (@a.AccountNo)</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">From</label>
            <input type="date" class="form-control"
                   @bind-value="FromDate" @bind-value:format="yyyy-MM-dd" />
        </div>

        <div class="col-md-3">
            <label class="form-label">To</label>
            <input type="date" class="form-control"
                   @bind-value="ToDate" @bind-value:format="yyyy-MM-dd" />
        </div>

        <div class="col-md-1 d-grid">
            <button class="btn btn-primary" @onclick="LoadAsync">Go</button>
        </div>
    </div>

    <div class="mt-3 d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" @onclick="ThisMonth">This Month</button>
        <button class="btn btn-outline-secondary btn-sm" @onclick="Last30Days">Last 30 Days</button>
    </div>
</div>

<div class="card p-3 shadow-sm rounded-4">
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr class="text-uppercase text-muted small">
                    <th>Date</th>
                    <th>Ref</th>
                    <th>Narration</th>
                    <th class="text-end">Debit</th>
                    <th class="text-end">Credit</th>
                    <th class="text-end">Balance</th>
                </tr>
            </thead>
            <tbody>
                <tr class="table-light">
                    <td colspan="5" class="fw-semibold">Opening Balance</td>
                    <td class="text-end fw-bold">@_openingBalance.ToString("N2")</td>
                </tr>

                @if (_rows.Count == 0)
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">No entries.</td>
                    </tr>
                }
                else
                {
                    @foreach (var r in _rows)
                    {
                        <tr>
                            <td>@r.TxnDate.ToString("dd-MM-yyyy")</td>

                            <td>
                                @if (!string.IsNullOrWhiteSpace(r.RefNo))
                                {
                                    <a href="@($"/voucher/{Uri.EscapeDataString(r.RefNo)}")">@r.RefNo</a>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>

                            <td>@(r.Narration ?? "—")</td>
                            <td class="text-end">@r.Debit.ToString("N2")</td>
                            <td class="text-end">@r.Credit.ToString("N2")</td>
                            <td class="text-end fw-semibold">@r.RunningBalance.ToString("N2")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    [Parameter] public int AccountNo { get; set; }

    private string? _error;
    private decimal _openingBalance;

    private int _companyId;

    private List<CoaMini> Accounts = new();
    private int SelectedAccountNo;

    private DateTime FromDate = DateTime.Today.AddDays(-30);
    private DateTime ToDate = DateTime.Today;

    private List<Row> _rows = new();

    protected override async Task OnInitializedAsync()
    {
        await CurrentCompany.RefreshAsync();
        _companyId = CurrentCompany.CompanyId;

        if (_companyId <= 0)
        {
            _error = "CompanyId not found from login/session.";
            return;
        }

        await LoadAccountsAsync();

        SelectedAccountNo = AccountNo;
        if (SelectedAccountNo == 0 && Accounts.Count > 0)
            SelectedAccountNo = Accounts[0].AccountNo;

        await LoadAsync();
    }

    private async Task LoadAccountsAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        Accounts = await db.ChartOfAccounts
            .AsNoTracking()
            .Where(x => x.CompanyId == _companyId)
            .OrderBy(x => x.AccountNo)
            .Select(x => new CoaMini { AccountNo = x.AccountNo, AccountName = x.AccountName })
            .ToListAsync();
    }

    private async Task AccountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var n))
        {
            SelectedAccountNo = n;
            Nav.NavigateTo($"/ledger/{SelectedAccountNo}");
            await LoadAsync();
        }
    }

    private async Task LoadAsync()
    {
        _error = null;
        _rows.Clear();

        try
        {
            var from = FromDate.Date;
            var toExclusive = ToDate.Date.AddDays(1);

            await using var db = await DbFactory.CreateDbContextAsync();

            _openingBalance = await db.LedgerEntries
                .AsNoTracking()
                .Where(x => x.CompanyId == _companyId
                         && x.AccountNo == SelectedAccountNo
                         && x.TxnDate < from)
                .Select(x => x.Debit - x.Credit)
                .SumAsync();

            var entries = await db.LedgerEntries
                .AsNoTracking()
                .Where(x => x.CompanyId == _companyId
                         && x.AccountNo == SelectedAccountNo
                         && x.TxnDate >= from
                         && x.TxnDate < toExclusive)
                .OrderBy(x => x.TxnDate)
                .ThenBy(x => x.Id)
                .ToListAsync();

            decimal running = _openingBalance;

            foreach (var le in entries)
            {
                running += (le.Debit - le.Credit);

                _rows.Add(new Row
                    {
                        TxnDate = le.TxnDate,
                        RefNo = le.RefNo,
                        Narration = le.Narration,
                        Debit = le.Debit,
                        Credit = le.Credit,
                        RunningBalance = running
                    });
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private Task ThisMonth()
    {
        var now = DateTime.Today;
        FromDate = new DateTime(now.Year, now.Month, 1);
        ToDate = now;
        return LoadAsync();
    }

    private Task Last30Days()
    {
        var now = DateTime.Today;
        FromDate = now.AddDays(-30);
        ToDate = now;
        return LoadAsync();
    }

    private sealed class CoaMini
    {
        public int AccountNo { get; set; }
        public string AccountName { get; set; } = "";
    }

    private sealed class Row
    {
        public DateTime TxnDate { get; set; }
        public string? RefNo { get; set; }
        public string? Narration { get; set; }
        public decimal Debit { get; set; }
        public decimal Credit { get; set; }
        public decimal RunningBalance { get; set; }
    }
}
