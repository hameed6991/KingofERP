@page "/insights"
@using UaeEInvoice.Services.Analytics
@using UaeEInvoice.Services.Auth
@inject AnalyticsService Analytics
@inject ICurrentCompany CurrentCompany
@inject NavigationManager Nav

<style>
    /* ===== Ultra Premium BI Look ===== */
    .bi-wrap {
        min-height: calc(100vh - 90px);
        background: radial-gradient(900px 450px at 15% 0%, rgba(13,110,253,.12), transparent 60%), radial-gradient(900px 450px at 85% 0%, rgba(25,135,84,.10), transparent 60%), linear-gradient(180deg, rgba(248,249,250,1), rgba(255,255,255,1));
        border-radius: 18px;
        padding: 22px;
    }

    .bi-title {
        letter-spacing: -0.6px;
        font-weight: 800;
        font-size: clamp(28px, 3vw, 44px);
        margin: 0;
        line-height: 1.05;
    }

    .bi-sub {
        color: rgba(33,37,41,.70);
        margin-top: 6px;
        font-size: 15px;
    }

    .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(0,0,0,.08);
        background: rgba(255,255,255,.70);
        box-shadow: 0 8px 22px rgba(0,0,0,.04);
        backdrop-filter: blur(8px);
    }

    .bi-card {
        border: 1px solid rgba(0,0,0,.07);
        border-radius: 18px;
        background: rgba(255,255,255,.75);
        box-shadow: 0 10px 30px rgba(0,0,0,.05);
        backdrop-filter: blur(10px);
        transition: transform .12s ease, box-shadow .12s ease;
        overflow: hidden;
    }

        .bi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 40px rgba(0,0,0,.08);
        }

        .bi-card .cap {
            color: rgba(33,37,41,.62);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .10em;
        }

        .bi-card .big {
            font-weight: 800;
            font-size: 42px;
            letter-spacing: -1px;
            line-height: 1.0;
            margin-top: 6px;
        }

        .bi-card .meta {
            color: rgba(33,37,41,.65);
            font-size: 14px;
            margin-top: 6px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(13,110,253,.08);
        border: 1px solid rgba(13,110,253,.18);
        color: rgba(13,110,253,.95);
        font-size: 12px;
        font-weight: 600;
    }

        .chip.warn {
            background: rgba(220,53,69,.08);
            border-color: rgba(220,53,69,.18);
            color: rgba(220,53,69,.95);
        }

        .chip.ok {
            background: rgba(25,135,84,.10);
            border-color: rgba(25,135,84,.18);
            color: rgba(25,135,84,.95);
        }

        .chip.neutral {
            background: rgba(108,117,125,.10);
            border-color: rgba(108,117,125,.18);
            color: rgba(108,117,125,.95);
        }

    .bi-btn {
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
    }

    .bi-btn-soft {
        border-radius: 12px;
        padding: 9px 12px;
        font-weight: 700;
        border: 1px solid rgba(0,0,0,.08);
        background: rgba(255,255,255,.72);
    }

    .mini-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 14px;
        padding: 10px 0;
        border-bottom: 1px dashed rgba(0,0,0,.10);
    }

        .mini-row:last-child {
            border-bottom: 0;
        }

    .mini-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 120px;
    }

    .spark {
        height: 10px;
        border-radius: 999px;
        background: rgba(0,0,0,.06);
        overflow: hidden;
        width: 100%;
    }

        .spark > span {
            display: block;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(13,110,253,.55), rgba(13,110,253,.95));
            width: 0%;
        }

    .muted {
        color: rgba(33,37,41,.62);
        font-size: 13px;
    }

    .skeleton {
        border-radius: 18px;
        border: 1px solid rgba(0,0,0,.07);
        background: linear-gradient(90deg, rgba(0,0,0,.04), rgba(0,0,0,.08), rgba(0,0,0,.04));
        background-size: 200% 100%;
        animation: shimmer 1.1s infinite linear;
        height: 140px;
    }
    @@keyframes shimmer {
        0%

    {
        background-position: 200% 0;
    }

    100% {
        background-position: -200% 0;
    }

    }
</style>

<div class="container-xxl py-4">

    <div class="bi-wrap">

        <!-- Header -->
        <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-3">
            <div>
                <h1 class="bi-title">Insights & Analytics (BI)</h1>
                <div class="bi-sub">Executive overview • trends • aging • VAT summary</div>

                <div class="d-flex gap-2 flex-wrap mt-3">
                    <span class="pill">
                        <span class="muted">Company</span>
                        <b>#@CurrentCompany.CompanyId</b>
                    </span>

                    <span class="pill">
                        <span class="muted">As of</span>
                        <b>@DateTime.Today.ToString("dd MMM yyyy")</b>
                    </span>

                    <span class="pill">
                        <span class="muted">Updated</span>
                        <b>@(_lastUpdated == null ? "-" : _lastUpdated.Value.ToString("hh:mm:ss tt"))</b>
                    </span>
                </div>
            </div>

            <div class="d-flex gap-2 align-items-center flex-wrap">
                <div class="btn-group" role="group" aria-label="trend range">
                    <button class="btn bi-btn-soft @( _trendDays==30 ? "active" : "" )" @onclick="(()=>SetTrendDays(30))">30d</button>
                    <button class="btn bi-btn-soft @( _trendDays==90 ? "active" : "" )" @onclick="(()=>SetTrendDays(90))">90d</button>
                </div>

                <button class="btn bi-btn-soft" @onclick="Load" disabled="@_loading">
                    @(_loading ? "Refreshing..." : "Refresh")
                </button>

                <button class="btn btn-primary bi-btn" @onclick="@(()=>Nav.NavigateTo("/invoice-create"))">
                    Create Invoice
                </button>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_err))
        {
            <div class="alert alert-danger rounded-4 border-0 shadow-sm">
                <b>Analytics error:</b> @_err
                <div class="muted mt-1">Tip: Ensure data exists and company filters are correct.</div>
            </div>
        }

        @if (_loading && _kpis is null)
        {
            <div class="row g-3">
                <div class="col-12 col-lg-3"><div class="skeleton"></div></div>
                <div class="col-12 col-lg-3"><div class="skeleton"></div></div>
                <div class="col-12 col-lg-3"><div class="skeleton"></div></div>
                <div class="col-12 col-lg-3"><div class="skeleton"></div></div>
                <div class="col-12 col-lg-6"><div class="skeleton" style="height:170px"></div></div>
                <div class="col-12 col-lg-6"><div class="skeleton" style="height:170px"></div></div>
            </div>
        }
        else if (_kpis is not null)
        {
            <!-- KPI Row -->
            <div class="row g-3">
                <div class="col-12 col-lg-3">
                    <div class="bi-card p-3 h-100">
                        <div class="cap">Revenue (MTD)</div>
                        <div class="big">@Fmt(_kpis.SalesMtd)</div>
                        <div class="meta">
                            <span class="chip neutral">Invoices</span>
                            <span class="muted">This month</span>
                        </div>
                        <button class="btn btn-outline-primary bi-btn w-100 mt-3"
                                @onclick="@(()=>Nav.NavigateTo("/invoices"))">
                            View Invoices
                        </button>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <div class="bi-card p-3 h-100">
                        <div class="cap">Purchases (MTD)</div>
                        <div class="big">@Fmt(_kpis.PurchasesMtd)</div>
                        <div class="meta">
                            <span class="chip neutral">Bills</span>
                            <span class="muted">This month</span>
                        </div>
                        <button class="btn btn-outline-primary bi-btn w-100 mt-3"
                                @onclick="@(()=>Nav.NavigateTo("/purchases"))">
                            View Purchases
                        </button>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <div class="bi-card p-3 h-100">
                        <div class="cap">Accounts Receivable</div>
                        <div class="big">@Fmt(_kpis.ArOutstanding)</div>

                        <div class="meta">
                            <span class="chip @( _kpis.ArOverdue>0 ? "warn" : "ok")">
                                Overdue: @Fmt(_kpis.ArOverdue)
                            </span>
                            <span class="muted">Open balances</span>
                        </div>

                        <button class="btn btn-outline-primary bi-btn w-100 mt-3"
                                @onclick="@(()=>Nav.NavigateTo("/customers"))">
                            Customers
                        </button>
                    </div>
                </div>

                <div class="col-12 col-lg-3">
                    <div class="bi-card p-3 h-100">
                        <div class="cap">Accounts Payable</div>
                        <div class="big">@Fmt(_kpis.ApOutstanding)</div>

                        <div class="meta">
                            <span class="chip @( _kpis.ApOverdue>0 ? "warn" : "ok")">
                                Overdue: @Fmt(_kpis.ApOverdue)
                            </span>
                            <span class="muted">Open balances</span>
                        </div>

                        <button class="btn btn-outline-primary bi-btn w-100 mt-3"
                                @onclick="@(()=>Nav.NavigateTo("/vendors"))">
                            Vendors
                        </button>
                    </div>
                </div>

                <!-- VAT + Trend -->
                <div class="col-12 col-lg-5">
                    <div class="bi-card p-3 h-100">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="cap">VAT (MTD)</div>
                                <div class="d-flex align-items-baseline gap-2 mt-2">
                                    <div class="h2 fw-bold mb-0">Net: @Fmt(_kpis.VatNetMtd)</div>
                                    <span class="chip @( _kpis.VatNetMtd>0 ? "warn" : "ok")">
                                        @(_kpis.VatNetMtd > 0 ? "Payable" : "Receivable/Zero")
                                    </span>
                                </div>
                                <div class="muted mt-2">
                                    Output: <b>@Fmt(_kpis.VatOutputMtd)</b> • Input: <b>@Fmt(_kpis.VatInputMtd)</b>
                                </div>
                            </div>
                            <button class="btn btn-outline-primary bi-btn" @onclick="@(()=>Nav.NavigateTo("/vat"))">VAT Page</button>
                        </div>

                        <div class="mt-3">
                            <div class="muted">VAT health</div>
                            <div class="d-flex gap-2 flex-wrap mt-1">
                                <span class="chip">Tax ready</span>
                                <span class="chip neutral">This month</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-7">
                    <div class="bi-card p-3 h-100">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="cap">Sales Trend</div>
                                <div class="h5 fw-bold mb-0">Last @_trendDays days</div>
                                <div class="muted">Quick view (top 7 recent days)</div>
                            </div>
                            <button class="btn bi-btn-soft" @onclick="@(()=>Nav.NavigateTo("/insights/sales-trend"))">
                                Open
                            </button>
                        </div>

                        @if (_trend.Count == 0)
                        {
                            <div class="muted">No trend data.</div>
                        }
                        else
                        {
                            @foreach (var p in _trend.TakeLast(7))
                            {
                                var w = SparkWidth(p.Value);
                                <div class="mini-row">
                                    <div class="mini-left">
                                        <div class="fw-semibold">@p.Day.ToString("dd MMM")</div>
                                        <div class="muted">@p.Count invoice(s)</div>
                                    </div>

                                    <div class="flex-grow-1">
                                        <div class="spark">
                                            <span style="width:@w%"></span>
                                        </div>
                                        <div class="muted mt-1">AED @Fmt(p.Value)</div>
                                    </div>

                                    <div class="fw-bold" style="min-width:110px; text-align:right;">
                                        @Fmt(p.Value)
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Aging (Premium) -->
                <div class="col-12 col-lg-6">
                    <div class="bi-card p-3 h-100">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="cap">Receivables Aging</div>
                                <div class="h5 fw-bold mb-0">AR buckets</div>
                                <div class="muted">Where collections are stuck</div>
                            </div>
                            <button class="btn bi-btn-soft" @onclick="@(()=>Nav.NavigateTo("/insights/aging"))">Open</button>
                        </div>

                        @if (_ar.Buckets.Count == 0)
                        {
                            <div class="muted">No open AR found.</div>
                        }
                        else
                        {
                            @foreach (var b in _ar.Buckets)
                            {
                                var pct = BucketPct(_ar.Total, b.Amount);
                                <div class="mini-row">
                                    <div class="fw-semibold" style="min-width:70px">@b.Bucket</div>
                                    <div class="flex-grow-1">
                                        <div class="spark">
                                            <span style="width:@pct%"></span>
                                        </div>
                                        <div class="muted mt-1">@b.Count invoice(s)</div>
                                    </div>
                                    <div class="fw-bold" style="min-width:120px; text-align:right;">@Fmt(b.Amount)</div>
                                </div>
                            }
                            <div class="d-flex justify-content-between mt-2">
                                <div class="muted">Total open AR</div>
                                <div class="fw-bold">@Fmt(_ar.Total)</div>
                            </div>
                        }
                    </div>
                </div>

                <div class="col-12 col-lg-6">
                    <div class="bi-card p-3 h-100">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="cap">Payables Aging</div>
                                <div class="h5 fw-bold mb-0">AP buckets</div>
                                <div class="muted">Upcoming vendor pressure</div>
                            </div>
                            <button class="btn bi-btn-soft" @onclick="@(()=>Nav.NavigateTo("/insights/aging"))">Open</button>
                        </div>

                        @if (_ap.Buckets.Count == 0)
                        {
                            <div class="muted">No open AP found.</div>
                        }
                        else
                        {
                            @foreach (var b in _ap.Buckets)
                            {
                                var pct = BucketPct(_ap.Total, b.Amount);
                                <div class="mini-row">
                                    <div class="fw-semibold" style="min-width:70px">@b.Bucket</div>
                                    <div class="flex-grow-1">
                                        <div class="spark">
                                            <span style="width:@pct%"></span>
                                        </div>
                                        <div class="muted mt-1">@b.Count bill(s)</div>
                                    </div>
                                    <div class="fw-bold" style="min-width:120px; text-align:right;">@Fmt(b.Amount)</div>
                                </div>
                            }
                            <div class="d-flex justify-content-between mt-2">
                                <div class="muted">Total open AP</div>
                                <div class="fw-bold">@Fmt(_ap.Total)</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

    </div>
</div>

@code {
    bool _loading;
    string? _err;

    ExecKpis? _kpis;
    List<TrendPoint> _trend = new();
    AgingResult _ar = new(new(), 0m);
    AgingResult _ap = new(new(), 0m);

    int _trendDays = 30;
    DateTime? _lastUpdated;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task SetTrendDays(int days)
    {
        _trendDays = days;
        await Load();
    }

    private async Task Load()
    {
        _loading = true;
        _err = null;

        try
        {
            var cid = CurrentCompany.CompanyId;
            var asOf = DateTime.Today;

            _kpis = await Analytics.GetExecutiveKpis(cid, asOf);
            _trend = await Analytics.GetSalesTrendDaily(cid, _trendDays, asOf);
            _ar = await Analytics.GetArAging(cid, asOf);
            _ap = await Analytics.GetApAging(cid, asOf);

            _lastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            _err = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private static string Fmt(decimal v) => v.ToString("0.00");

    // For sales trend spark width (relative to max of currently loaded series)
    private double SparkWidth(decimal value)
    {
        if (_trend is null || _trend.Count == 0) return 0;
        var max = _trend.Max(x => x.Value);
        if (max <= 0) return 0;
        var pct = (double)(value / max) * 100.0;
        return Math.Max(0, Math.Min(100, pct));
    }

    private static double BucketPct(decimal total, decimal amount)
    {
        if (total <= 0) return 0;
        var pct = (double)(amount / total) * 100.0;
        return Math.Max(0, Math.Min(100, pct));
    }
}
